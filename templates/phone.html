{% extends 'layout.html' %}
{% block title %}C치mara Cliente{% endblock %}
{% block nav_camera_active %}btn-blue active{% endblock %}

{% block content %}
    <h1>Cliente de C치mara</h1>
    
    <!-- Corregido: sin width/height en el tag <video> -->
    <video id="video" autoplay playsinline muted class="video-wrapper"></video>
    
    <!-- El canvas MANTIENE su tama침o, esto es lo que enviamos -->
    <canvas id="canvas" width="480" height="360" style="display: none;"></canvas>
    
    <div id="status" class="status-badge" style="position: relative; width: 100%; margin: 1rem 0; background-color: #555; text-align: center;">
        Presiona "Iniciar" para transmitir.
    </div>
    
    <div class="controls d-grid gap-2" style="display: grid; gap: 1rem;">
        <label for="cameraSelect" style="text-align: left; color: #adb5bd;">Seleccionar C치mara:</label>
        <select id="cameraSelect" class="mb-2"></select>
        <button id="cycleCamBtn" class="pushable btn-blue" disabled>
            <span class="shadow"></span><span class="edge"></span><span class="front">Girar C치mara 游댃</span>
        </button>
        <button id="torchBtn" class="pushable btn-yellow" disabled>
            <span class="shadow"></span><span class="edge"></span><span class="front">Linterna 游댡</span>
        </button>
        <button id="toggleStreamBtn" class="pushable btn-green">
            <span class="shadow"></span><span class="edge"></span><span class="front">Iniciar Transmisi칩n</span>
        </button>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        // --- (Constantes) ---
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const context = canvas.getContext('2d');
        const status = document.getElementById('status');
        const toggleBtn = document.getElementById('toggleStreamBtn');
        const toggleBtnFront = toggleBtn.querySelector('.front');
        const torchBtn = document.getElementById('torchBtn');
        const torchBtnFront = torchBtn.querySelector('.front');
        const cameraSelect = document.getElementById('cameraSelect');
        const cycleCamBtn = document.getElementById('cycleCamBtn');
        
        let isStreaming = false;
        let streamInstance = null;
        let videoTrack = null;
        let torchOn = false;
        let pollIntervalId = null;
        let infoUpdateIntervalId = null; 
        let lastCycleRequest = 0; 
        let hasTorchCapability = false;
        
        // 춰Ya no necesitamos frameIntervalId!

        const socket = io();

        // --- (getCameras) ---
        async function getCameras() {
            try {
                await navigator.mediaDevices.getUserMedia({ video: true });
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                if (videoDevices.length === 0) { 
                    status.textContent = "Error: No se encontraron c치maras.";
                    status.style.backgroundColor = 'hsl(0, 70%, 55%)';
                    return; 
                }
                cameraSelect.innerHTML = '';
                videoDevices.forEach((device, index) => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    option.text = device.label || `C치mara ${index + 1}`;
                    cameraSelect.appendChild(option);
                });
            } catch (err) {
                console.log("Ocurri칩 un error: " + err);
                status.textContent = "Error al acceder a la c치mara.";
                status.style.backgroundColor = 'hsl(0, 70%, 55%)';
            }
        }
        window.addEventListener('load', getCameras);
        
        // --- (Botones de Control - con cooldown de linterna) ---
        toggleBtn.onclick = function() {
            if (isStreaming) { stopStream(); } else { startStream(); }
        };

        torchBtn.onclick = function() {
            torchBtn.disabled = true;
            torchOn = !torchOn;
            applyTorch();
            sendCommand('torch', torchOn ? 'on' : 'off');
            setTimeout(() => {
                if (isStreaming && hasTorchCapability) {
                    torchBtn.disabled = false;
                }
            }, 1500); // 1.5 segundos
        }

        cycleCamBtn.onclick = function() {
            cycleCamera(); 
        }
        
        // --- (startStream) ---
        function startStream() {
            const constraints = { 
                video: { deviceId: { exact: cameraSelect.value } }, 
                audio: false 
            };
            status.textContent = "Iniciando c치mara...";
            
            navigator.mediaDevices.getUserMedia(constraints)
                .then(function(stream) {
                    streamInstance = stream;
                    video.srcObject = stream;
                    video.play(); 
                    
                    video.onplaying = () => {
                        console.log("Video AHORA S칈 est치 reproduciendo. Iniciando stream.");
                        
                        if (socket.disconnected) { socket.connect(); }
                        
                        videoTrack = stream.getVideoTracks()[0];
                        checkTorchSupport(); 

                        if (cameraSelect.options.length > 1) {
                            cycleCamBtn.disabled = false;
                        }

                        status.textContent = "춰Transmitiendo! 游댮";
                        status.style.backgroundColor = 'hsl(140, 50%, 50%)';
                        
                        toggleBtnFront.textContent = "Detener Transmisi칩n";
                        toggleBtn.classList.remove('btn-green');
                        toggleBtn.classList.add('btn-red');

                        isStreaming = true; 
                        cameraSelect.disabled = true;
                        
                        // Iniciar el bucle de env칤o con "ack"
                        requestAnimationFrame(sendFrameLoop);
                        
                        pollIntervalId = setInterval(pollServer, 1000);
                        
                        try {
                            sendDeviceInfo("auto"); 
                            infoUpdateIntervalId = setInterval(sendDeviceInfo, 5000); 
                        } catch(e) {
                            console.error("Error iniciando el env칤o de info:", e);
                        }
                        
                        sendCommand('stream', 'on');
                    };

                    video.onerror = (e) => {
                         status.textContent = "Error al reproducir el video local.";
                         status.style.backgroundColor = 'hsl(0, 70%, 55%)';
                         console.log("Error de video:", e);
                    };
                })
                .catch(function(err) {
                    status.textContent = "Error al iniciar c치mara seleccionada.";
                    status.style.backgroundColor = 'hsl(0, 70%, 55%)';
                    console.log(err);
                });
        }

        // --- (stopStream) ---
        function stopStream() {
            if (!isStreaming) return; 
            isStreaming = false;
            
            if (streamInstance) {
                streamInstance.getTracks().forEach(track => track.stop());
            }
            video.srcObject = null;
            video.onplaying = null;
            video.onerror = null;

            status.textContent = "Transmisi칩n detenida.";
            status.style.backgroundColor = '#555';

            toggleBtnFront.textContent = "Iniciar Transmisi칩n";
            toggleBtn.classList.remove('btn-red');
            toggleBtn.classList.add('btn-green');

            videoTrack = null;
            torchBtn.disabled = true; 
            hasTorchCapability = false; 
            cameraSelect.disabled = false;
            cycleCamBtn.disabled = true;

            if (pollIntervalId) clearInterval(pollIntervalId);
            if (infoUpdateIntervalId) clearInterval(infoUpdateIntervalId);
            
            sendDeviceInfo(null); 
            sendCommand('stream', 'off');
        }

        // --- (sendFrameLoop - 춰ACTUALIZADO!) ---
        function sendFrameLoop() {
            if (!isStreaming) return; // Si apretamos 'stop', el bucle se detiene
            
            context.drawImage(video, 0, 0, 480, 360);
            let dataURL = canvas.toDataURL('image/jpeg', 0.3);
            
            // 1. Enviamos el frame por el WebSocket
            // 2. A침adimos un callback (el 'ack')
            socket.emit('send_frame', dataURL, () => {
                // 3. Cuando el servidor responde "OK" (ack),
                //    pedimos el siguiente frame.
                requestAnimationFrame(sendFrameLoop);
            });
        }

        // --- (pollServer) ---
        async function pollServer() {
            if (!isStreaming) return;
            try {
                const response = await fetch('/control/poll');
                const command = await response.json(); 
                if (command.torch_on !== torchOn) {
                    torchOn = command.torch_on;
                    applyTorch();
                }
                if (command.stream_on === false) {
                    console.log("Comando de detener stream recibido del server.");
                    stopStream();
                }
                if (command.cycle_camera_request > lastCycleRequest) {
                    console.log("Comando de girar c치mara recibido del server.");
                    lastCycleRequest = command.cycle_camera_request;
                    cycleCamera();
                }
            } catch (e) {
                console.log("Error de polling:", e);
            }
        }
        
        // --- (applyTorch) ---
        function applyTorch() {
            if (!videoTrack || !hasTorchCapability) return;
            videoTrack.applyConstraints({
                advanced: [{ torch: torchOn }]
            }).catch(err => console.log("Error al aplicar linterna: " + err));
            
            if (torchOn) {
                torchBtnFront.textContent = 'Apagar Linterna 游댮';
                torchBtn.classList.remove('btn-yellow');
                torchBtn.classList.add('btn-red');
            } else {
                torchBtnFront.textContent = 'Linterna 游댡';
                torchBtn.classList.remove('btn-red');
                torchBtn.classList.add('btn-yellow');
            }
        }

        // --- (sendCommand) ---
        function sendCommand(key, value) {
             fetch('/control/command', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ [key]: value })
            }).catch(err => console.log(`Error al enviar comando ${key}:`, err));
        }

        // --- (checkTorchSupport) ---
        function checkTorchSupport() {
            if (videoTrack && videoTrack.getCapabilities().torch) {
                hasTorchCapability = true;
                torchBtn.disabled = false;
            } else {
                torchBtn.disabled = true;
                hasTorchCapability = false;
            }
        }
        
        // --- (cycleCamera) ---
        function cycleCamera() {
            if (!isStreaming) return; 
            let currentIdx = cameraSelect.selectedIndex;
            let nextIdx = (currentIdx + 1) % cameraSelect.options.length;
            cameraSelect.selectedIndex = nextIdx;
            stopStream();
            setTimeout(startStream, 100); 
        }
        
        // --- (sendDeviceInfo) ---
        async function sendDeviceInfo(info = "auto") {
            let deviceInfo = null;
            if (info === "auto") {
                let battery = { level: -1, charging: false };
                try {
                    if (navigator.getBattery) {
                         battery = await navigator.getBattery();
                    }
                } catch(e) { console.log("No se pudo acceder a la bater칤a."); }
                
                deviceInfo = {
                    camera: videoTrack ? videoTrack.label : 'N/A',
                    userAgent: navigator.userAgent,
                    battery: `${Math.round(battery.level * 100)}% ${battery.charging ? '(Cargando)' : ''}`,
                    network: navigator.connection ? navigator.connection.effectiveType : 'unknown',
                    has_torch: hasTorchCapability 
                };
            }
            fetch('/device/info', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(deviceInfo)
            }).catch(err => console.log('Error al enviar info del dispositivo:', err));
        }
    </script>
{% endblock %}

